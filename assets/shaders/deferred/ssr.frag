#version 420 core
#include"../octmap.glsl"
layout(binding=0)uniform sampler2D attachments;layout(binding=1)uniform sampler2D finalimg;layout(binding=2)uniform sampler2D depth_sampler;layout(binding=3)uniform sampler2D normal;layout(binding=4)uniform sampler2D prev_ssr;uniform mat4 invView,invprojection;layout(std140, binding = 6)uniform Matrices{mat4 projection;mat4 view;};in vec2 TexCoords;out vec4 outColor;float v;
#define Scale vec3(.8,.8,.8)
#define K 19.19
float f;vec3 t(float v){if(v>=1.)return vec3(0);vec4 f=invprojection*vec4(TexCoords*2.-1.,v*2.-1.,1);f/=f.w;return f.xyz;}vec3 t(inout vec3 v,inout vec3 f,inout float s){float i;vec4 n;for(int g=0;g<5;g++){n=projection*vec4(f,1);n.xy/=n.w;n.xy=n.xy*.5+.5;float y=texture2D(depth_sampler,n.xy).x;i=t(y).z;s=f.z-i;v*=.5;f=s>0.?f+v:f-v;}n=projection*vec4(f,1);n.xy/=n.w;n.xy=n.xy*.5+.5;return vec3(n.xy,i);}vec4 e(vec3 v,inout vec3 n,out float f){v*=.1;float i;int s;vec4 g;for(int y=0;y<30;y++){n+=v;g=projection*vec4(n,1);g.xy/=g.w;g.xy=g.xy*.5+.5;float d=texture2D(depth_sampler,g.xy).x;i=t(d).z;if(i>1e3)continue;f=n.z-i;if(v.z-f<1.2)if(f<=0.)return vec4(t(v,n,f),1);s++;}return vec4(g.xy,i,0);}vec3 e(vec3 v){v=fract(vec3(v)*Scale);v+=dot(v,v.yzx+K);return fract((v.xxy+v.yzz)*v.zyx);}void main(){v=texture(attachments,TexCoords).y;if(v<.01)discard;vec3 s=(vec4(normalize(signed_oct_to_float32x3(texelFetch(normal,ivec2(gl_FragCoord.xy),0).xyz)),1)*invView).xyz;f=texture2D(depth_sampler,TexCoords).x;vec3 n=t(f),i=mix(vec3(.04),texture(finalimg,TexCoords).xyz,v),g=normalize(reflect(normalize(n),normalize(s))),y=n;float r;vec3 d=mix(vec3(0),vec3(e(vec3(vec4(n,1)*invView))),texture(attachments,TexCoords).x);vec4 T=e(vec3(d)+g*max(.1,-n.z),y,r);vec2 m=smoothstep(.2,.6,abs(vec2(.5)-T.xy));r=pow(v,3.)*clamp(1.-m.x-m.y,0.,1.)*-g.z;outColor=vec4(texture(finalimg,T.xy).xyz*clamp(r,0.,.9)*(i+(1.-i)*pow(1.-max(dot(normalize(s),normalize(n)),0.),5.)),v);}