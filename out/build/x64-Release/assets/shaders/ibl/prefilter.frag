#version 420
out vec4 FragColor;in vec3 WorldPos;layout(binding=0)uniform samplerCube environmentMap;uniform float roughness;float t(vec3 d,vec3 u){float s=roughness*roughness,v=s*s,r=max(dot(d,u),0.);s=r*r*(v-1.)+1.;s*=acos(-1.)*s;return v/s;}float t(uint u){u=u<<16u|u>>16u;u=(u&1431655765u)<<1u|(u&2863311530u)>>1u;u=(u&858993459u)<<2u|(u&3435973836u)>>2u;u=(u&252645135u)<<4u|(u&4042322160u)>>4u;u=(u&16711935u)<<8u|(u&4278255360u)>>8u;return float(u)*.0000000002328306;}vec3 t(vec2 s,vec3 u){float r=roughness*roughness,v=2.*acos(-1.)*s.x,m=sqrt((1.-s.y)/(1.+(r*r-1.)*s.y));r=sqrt(1.-m*m);vec3 f;f.x=cos(v)*r;f.y=sin(v)*r;f.z=m;vec3 n=normalize(cross(abs(u.z)<.999?vec3(0,0,1):vec3(1,0,0),u));f=n*f.x+cross(u,n)*f.y+u*f.z;return normalize(f);}void main(){vec3 u=normalize(WorldPos),v=vec3(0);float r=0.;for(uint f=0u;f<1024u;++f){vec2 s=vec2(float(f)/float(1024u),t(f));vec3 d=t(s,u),m=normalize(2.*dot(u,d)*d-u);float n=max(dot(u,m),0.);if(n>0.)v+=textureLod(environmentMap,m,roughness==0.?0.:.5*log2(1./(float(1024u)*(t(u,d)*max(dot(u,d),0.)/(4.*max(dot(d,u),0.))+1e-4)+1e-4)/(4.*acos(-1.)/100663296.))).xyz*n,r+=n;}v/=r;FragColor=vec4(v,1);}