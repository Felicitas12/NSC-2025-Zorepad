#version 430 core
layout(binding=0)uniform sampler2D u_colorTexture;uniform vec2 u_texelStep;uniform int u_showEdges,u_fxaaOn;uniform float u_lumaThreshold,u_mulReduce,u_minReduce,u_maxSpan;in vec2 v_texCoord;out vec4 fragColor;void main(){vec3 u=texture(u_colorTexture,v_texCoord).xyz;if(u_fxaaOn==0){fragColor=vec4(u,1);return;}vec3 e=textureOffset(u_colorTexture,v_texCoord,ivec2(-1,1)).xyz,v=textureOffset(u_colorTexture,v_texCoord,ivec2(1,1)).xyz,d=textureOffset(u_colorTexture,v_texCoord,ivec2(-1,-1)).xyz,m=textureOffset(u_colorTexture,v_texCoord,ivec2(1,-1)).xyz;float t=dot(e,vec3(.299,.587,.114)),i=dot(v,vec3(.299,.587,.114)),r=dot(d,vec3(.299,.587,.114)),n=dot(m,vec3(.299,.587,.114)),z=dot(u,vec3(.299,.587,.114)),x=min(z,min(min(t,i),min(r,n)));z=max(z,max(max(t,i),max(r,n)));if(z-x<=z*u_lumaThreshold){fragColor=vec4(u,1);return;}vec2 f;f.x=-t-i+r+n;f.y=t+r-i-n;t=1./(min(abs(f.x),abs(f.y))+max((t+i+r+n)*.25*u_mulReduce,u_minReduce));f=clamp(f*t,vec2(-u_maxSpan),vec2(u_maxSpan))*u_texelStep;e=texture(u_colorTexture,v_texCoord+f*(1./3.-.5)).xyz;v=texture(u_colorTexture,v_texCoord+f*(2./3.-.5)).xyz;e=(v+e)*.5;v=texture(u_colorTexture,v_texCoord+f*-.5).xyz;d=texture(u_colorTexture,v_texCoord+f*.5).xyz;v=(d+v)*.25+e*.5;t=dot(v,vec3(.299,.587,.114));fragColor=t<x||t>z?vec4(e,1):vec4(v,1);if(u_showEdges!=0)fragColor.x=1.;}